---
title: "APCalign"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{APCalign}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



When working with biodiversity data, it is important to verify  taxonomic names with an authoritative list and correct any out-of-date names. The 'APCalign' package simplifies this process by:

-   Accessing up-to-date taxonomic information from the [Australian Plant Census](https://biodiversity.org.au/nsl/services/search/taxonomy) and the [Australia Plant Name Index](https://biodiversity.org.au/nsl/services/search/names).
-   Aligning authoritative names to your taxonomic names using our [fuzzy matching algorithm](https://traitecoevo.github.io/APCalign/articles/taxmatch.html)
-   Updating your taxonomic names in a transparent, reproducible manner

## Installation

'APCalign' is currently not on CRAN. You can install its current developmental version using


```r
# install.packages("remotes")
remotes::install_github("traitecoevo/APCalign")

library(APCalign)
```

To demonstrate how to use 'APCalign', we will use an example dataset `gbif_lite` which is documented in `?gbif_lite`


```r
dim(gbif_lite)
#> [1] 129   7

gbif_lite |> print(n = 6)
#> # A tibble: 129 × 7
#>   species              infraspecificepithet taxonrank decimalLongitude decimalLatitude scientificname
#>   <chr>                <chr>                <chr>                <dbl>           <dbl> <chr>         
#> 1 Tetratheca ciliata   <NA>                 SPECIES               145.           -37.4 Tetratheca ci…
#> 2 Peganum harmala      <NA>                 SPECIES               139.           -33.3 Peganum harma…
#> 3 Calotis multicaulis  <NA>                 SPECIES               115.           -24.3 Calotis multi…
#> 4 Leptospermum triner… <NA>                 SPECIES               151.           -34.0 Leptospermum …
#> 5 Lepidosperma latera… <NA>                 SPECIES               142.           -37.3 Lepidosperma …
#> 6 Enneapogon polyphyl… <NA>                 SPECIES               129.           -17.8 Enneapogon po…
#> # ℹ 123 more rows
#> # ℹ 1 more variable: verbatimscientificname <chr>
```

## Retrieve taxonomic resources

The first step is to retrieve the entire APC and APNI name databases and store them locally as taxonomic resources. We achieve this using `load_taxonomic_resources()`.

There are two versions of the databases that you can retrieve with the `stable_or_current_data` argument. Calling:

-   `stable` will retrieve the most recent, archived version of the databases from our [GitHub releases](https://github.com/traitecoevo/APCalign/releases). This is set as the default option.
-   `current` will retrieve the up-to-date databases directly from the APC and APNI website.

Note that the databases are quite large so the initial retrieval of `stable` versions will take a few minutes. Once the taxonomic resources have been stored locally, subsequent retrievals will take less time. Retrieving `current` resources will always take longer since it is. Check out our [Resource Caching](https://traitecoevo.github.io/APCalign/articles/caching.html) article to learn more about how the APC and APNIC databases are accessed, stored and retrieved.


```r
# Benchmarking the retrieval of `stable` or `current` resources
stable_start_time <- Sys.time()
stable_resources <- load_taxonomic_resources(stable_or_current_data = "stable")
#> Loading resources......done
stable_end_time <-  Sys.time()

current_start_time <- Sys.time()
current_resources <- load_taxonomic_resources(stable_or_current_data = "current")
#> Loading resources......done
current_end_time <-  Sys.time()

# Compare times
stable_end_time - stable_start_time
#> Time difference of 26.66634 secs
current_end_time - current_start_time
#> Time difference of 54.33515 secs
```

For a more reproducible workflow, we recommend specifying the exact `stable` version you want to use.


```r
resources <- load_taxonomic_resources(stable_or_current_data = "stable", version = "0.0.2.9000")
#> Loading resources......done
```

## Standardise plant taxon names

Now we can query our taxonomic names against the taxonomic resources we just retrieved using `create_taxonomic_update_lookup()`. This is an all-in-one function will:

- Align your taxonomic names to APNI and APC using our [fuzzy matching algorithm](https://traitecoevo.github.io/APCalign/articles/taxmatch.html)
- Update taxonomic names to APC accepted name.
- Returns NA for names where a match cannot be found

If you would like to learn more about each of these step, take a look at the section [Closer look at name standardisation with 'APCalign'](#closer-look)


```r
library(dplyr)
library(tidyr)

update_gbif_names <- gbif_lite |> 
  pull(species) |> 
  create_taxonomic_update_lookup(resources = resources)
#> Checking alignments of 121 taxa
#>   -> 0 names already matched; 0 names checked but without a match; 121 taxa yet to be checked

update_gbif_names |> print(n = 6)
#> # A tibble: 146 × 5
#>   original_name           aligned_name            apc_name      aligned_reason taxonomic_status_of_…¹
#>   <chr>                   <chr>                   <chr>         <chr>          <chr>                 
#> 1 Tetratheca ciliata      Tetratheca ciliata      Tetratheca c… match_06. Aut… accepted              
#> 2 Peganum harmala         Peganum harmala         Peganum harm… match_06. Aut… accepted              
#> 3 Calotis multicaulis     Calotis multicaulis     Calotis mult… match_06. Aut… accepted              
#> 4 Calotis multicaulis     Calotis multicaulis     Calotis plum… match_06. Aut… pro parte misapplied  
#> 5 Leptospermum trinervium Leptospermum trinervium Leptospermum… match_06. Aut… accepted              
#> 6 Lepidosperma laterale   Lepidosperma laterale   Lepidosperma… match_06. Aut… accepted              
#> # ℹ 140 more rows
#> # ℹ abbreviated name: ¹​taxonomic_status_of_aligned_name
```

The `original_name` is the taxon name used in your original data.
The `aligned_name` is the taxon name we used to link with the APC to identify any synonyms. 
The `apc_name` is the currently, accepted taxon name used by the Australian Plant Census.

We recommend joining the output of `create_taxonomic_update_lookup()` back to your original data so all names


```r
gbif_lite |> 
left_join(update_gbif_names,  # Left joining updated taxon names back to original data 
          by = join_by(species == original_name)) |> 
  select(species, ends_with("name"), # Rearranging naming columns
         aligned_reason, infraspecificepithet:decimalLatitude) |> 
  print(n = 6)
#> # A tibble: 154 × 11
#>   species          scientificname verbatimscientificname aligned_name apc_name taxonomic_status_of_…¹
#>   <chr>            <chr>          <chr>                  <chr>        <chr>    <chr>                 
#> 1 Tetratheca cili… Tetratheca ci… Tetratheca ciliata     Tetratheca … Tetrath… accepted              
#> 2 Peganum harmala  Peganum harma… Peganum harmala        Peganum har… Peganum… accepted              
#> 3 Calotis multica… Calotis multi… Calotis multicaulis    Calotis mul… Calotis… accepted              
#> 4 Calotis multica… Calotis multi… Calotis multicaulis    Calotis mul… Calotis… pro parte misapplied  
#> 5 Leptospermum tr… Leptospermum … Leptospermum trinervi… Leptospermu… Leptosp… accepted              
#> 6 Lepidosperma la… Lepidosperma … Lepidosperma laterale  Lepidosperm… Lepidos… accepted              
#> # ℹ 148 more rows
#> # ℹ abbreviated name: ¹​taxonomic_status_of_aligned_name
#> # ℹ 5 more variables: aligned_reason <chr>, infraspecificepithet <chr>, taxonrank <chr>,
#> #   decimalLongitude <dbl>, decimalLatitude <dbl>
```


## Plant established status across states/territories

'APCalign' can also provide the state/territory distribution for established status (native/introduced) from the APC.

We can access the established status data by state/territory using `create_species_state_origin_matrix()`


```r
# Retrieve status data by state/territory 
status_matrix <- create_species_state_origin_matrix(resources = resources)

status_matrix |> print(n = 6)
#> # A tibble: 26,243 × 19
#>   species   NT    Qld   WA    ChI   NSW   SA    Vic   Tas   ACT   NI    LHI   MI    HI    MDI   CoI  
#>   <chr>     <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr>
#> 1 Cycas an… nati… nati… not … not … not … not … not … not … not … not … not … not … not … not … not …
#> 2 Cycas ar… nati… not … not … not … not … not … not … not … not … not … not … not … not … not … not …
#> 3 Cycas ar… nati… not … not … not … not … not … not … not … not … not … not … not … not … not … not …
#> 4 Cycas ar… nati… not … not … not … not … not … not … not … not … not … not … not … not … not … not …
#> 5 Cycas ba… not … nati… not … not … not … not … not … not … not … not … not … not … not … not … not …
#> 6 Cycas ba… not … not … nati… not … not … not … not … not … not … not … not … not … not … not … not …
#> # ℹ 26,237 more rows
#> # ℹ 3 more variables: CSI <chr>, AR <chr>, CaI <chr>
```

Here is a breakdown of all possible values for `origin` 


```r
library(purrr)
library(janitor)

# Obtain unique values
status_matrix |> 
  select(-species) |> 
  flatten_chr() |> 
  tabyl()
#>  flatten_chr(select(status_matrix, -species))      n      percent
#>                        doubtfully naturalised   1120 2.371003e-03
#>                          formerly naturalised    277 5.863998e-04
#>                                        native  40336 8.538997e-02
#>             native and doubtfully naturalised      9 1.905270e-05
#>                        native and naturalised    136 2.879075e-04
#>                   native and uncertain origin      2 4.233933e-06
#>                                   naturalised   8765 1.855521e-02
#>                                   not present 421606 8.925258e-01
#>                              presumed extinct    101 2.138136e-04
#>                              uncertain origin     22 4.657327e-05
```

<!-- The formal definitions of the various established status can be found at XX.  -->

You can also obtain the breakdown of species by established status for a particular state/territory using `state_diversity_counts()`


```r
state_diversity_counts("NSW", resources = resources)
#> # A tibble: 7 × 3
#>   origin                            state num_species
#>   <chr>                             <chr> <table[1d]>
#> 1 doubtfully naturalised            NSW     93       
#> 2 formerly naturalised              NSW      8       
#> 3 native                            NSW   5958       
#> 4 native and doubtfully naturalised NSW      2       
#> 5 native and naturalised            NSW     34       
#> 6 naturalised                       NSW   1580       
#> 7 presumed extinct                  NSW      8
```

Using the established status data and state/territory information, we can check if a plant taxa is a native using `native_anywhere_in_australia()`


```r
update_gbif_names |> 
  sample_n(1) |>  # Choosing a random species
  pull(apc_name) |> # Extracting this APC accepted name
  native_anywhere_in_australia(resources = resources) 
#> # A tibble: 1 × 2
#>   species             native_anywhere_in_aus               
#>   <chr>               <chr>                                
#> 1 Hibbertia australis considered native to Australia by APC
```

## Closer look at name standardisation with 'APCalign' {#closer-look}

`create_taxonomic_update_lookup` is a simple, wrapper, function for novice users that want to quickly check and standardise taxon names. For more experienced users, you can take a look at the sub functions `align_taxa()` and `update_taxonomy()` to see how taxon names are processed, aligned and updated.

![](../man/figures/standardise_taxonomy_workflow.png)

### Aligning names to APNI and APC

This function will:

-   Clean up your taxonomic names <!-- (Getting rid of trailing whitespaces, case correction) -->
-   Find best alignment with APNI to your taxonomic name using our [fuzzy matching algorithm](https://traitecoevo.github.io/APCalign/articles/taxmatch.html)

You can control the degree of fuzzy matching using the arguments `max_distance_abs` and `max_distance_rel`

Note that the `aligned_name` may not be current. This does the best possible effort to match phrase names and subspecific taxa which often have alternative formatting.  This function also searches for small spelling or gender mistakes. 


```r
library(dplyr)
library(tidyr)

aligned_gbif_taxa <- gbif_lite |> 
  drop_na(species) |>  
  pull(species) |> 
  align_taxa(resources = resources)
#> Checking alignments of 121 taxa
#>   -> 0 names already matched; 0 names checked but without a match; 121 taxa yet to be checked

aligned_gbif_taxa |> print(n = 6)
#> # A tibble: 121 × 28
#>   original_name cleaned_name aligned_name source known checked stripped_name stripped_name2 trinomial
#>   <chr>         <chr>        <chr>        <chr>  <lgl> <lgl>   <chr>         <chr>          <chr>    
#> 1 Tetratheca c… Tetratheca … Tetratheca … <NA>   TRUE  TRUE    tetratheca c… tetratheca ci… <NA>     
#> 2 Peganum harm… Peganum har… Peganum har… <NA>   TRUE  TRUE    peganum harm… peganum harma… <NA>     
#> 3 Calotis mult… Calotis mul… Calotis mul… <NA>   TRUE  TRUE    calotis mult… calotis multi… <NA>     
#> 4 Leptospermum… Leptospermu… Leptospermu… <NA>   TRUE  TRUE    leptospermum… leptospermum … <NA>     
#> 5 Lepidosperma… Lepidosperm… Lepidosperm… <NA>   TRUE  TRUE    lepidosperma… lepidosperma … <NA>     
#> 6 Enneapogon p… Enneapogon … Enneapogon … <NA>   TRUE  TRUE    enneapogon p… enneapogon po… <NA>     
#> # ℹ 115 more rows
#> # ℹ 19 more variables: binomial <chr>, genus <chr>, aligned_reason <chr>, fuzzy_match_genus <chr>,
#> #   fuzzy_match_genus_known <chr>, fuzzy_match_genus_APNI <chr>, fuzzy_match_binomial <chr>,
#> #   fuzzy_match_binomial_APC_known <chr>, fuzzy_match_trinomial <chr>,
#> #   fuzzy_match_trinomial_known <chr>, fuzzy_match_cleaned_APC <chr>,
#> #   fuzzy_match_cleaned_APC_known <chr>, fuzzy_match_cleaned_APNI <chr>,
#> #   fuzzy_match_cleaned_APC_imprecise <chr>, fuzzy_match_cleaned_APC_known_imprecise <chr>, …
```

For every `aligned_name`, `align_taxa()` will provide a `aligned_reason` which you can review as a table of counts:


```r
library(janitor)

aligned_gbif_taxa |> 
  pull(aligned_reason) |> 
  tabyl() |> 
  tibble() 
#> # A tibble: 5 × 3
#>   `pull(aligned_gbif_taxa, aligned_reason)`                                                 n percent
#>   <chr>                                                                                 <int>   <dbl>
#> 1 match_06. Automatic alignment with accepted canonical names in APC (2023-08-09)         112 0.926  
#> 2 match_06. Automatic alignment with synonymous term among known canonical names APC (…     6 0.0496 
#> 3 match_08. Automatic alignment with synonymous name in APNI (2023-08-09)                   1 0.00826
#> 4 match_14. Automatic alignment with species-level canonical name in APC accepted when…     1 0.00826
#> 5 match_20. Rewording name to be recognised as genus rank, with genus accepted by APC …     1 0.00826
```

### Update taxonomic names to alignments

`update_taxonomy()` will update APNI taxa to specified (or current) version of APC. It will use the general synonymy published by the APC to attempt to sync the taxon names to a specific list. The function will also add other relevant taxonomy columns in the output



```r
updated_gbif_taxa <- aligned_gbif_taxa |> 
  pull(aligned_name) |> 
  update_taxonomy(resources = resources)

updated_gbif_taxa |> print(n = 6)
#> # A tibble: 148 × 14
#>   aligned_name    source taxonIDClean taxonomicStatusClean alternativeTaxonomic…¹ acceptedNameUsageID
#>   <chr>           <chr>  <chr>        <chr>                <chr>                  <chr>              
#> 1 Acacia aneura   APC    https://id.… accepted             misapplied | pro part… https://id.biodive…
#> 2 Acacia aneura   APC    https://id.… pro parte misapplied misapplied | pro part… https://id.biodive…
#> 3 Acacia aneura   APC    https://id.… pro parte misapplied misapplied | pro part… https://id.biodive…
#> 4 Acacia flavesc… APC    https://id.… accepted             <NA>                   https://id.biodive…
#> 5 Acacia gladiif… APC    https://id.… accepted             misapplied             https://id.biodive…
#> 6 Acacia melanox… APC    https://id.… accepted             misapplied             https://id.biodive…
#> # ℹ 142 more rows
#> # ℹ abbreviated name: ¹​alternativeTaxonomicStatusClean
#> # ℹ 8 more variables: canonicalName <chr>, scientificNameAuthorship <chr>, taxonRank <chr>,
#> #   taxonomicStatus <chr>, family <chr>, subclass <chr>, taxonDistribution <chr>,
#> #   ccAttributionIRI <chr>
```


